<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SMC Shipping Routes - Manual Routes</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
<style>
  html, body { margin:0; padding:0; }
  #map {
    width: 1005px;  /* exact map image width */
    height: 500px;  /* exact map image height */
    margin: 0 auto; /* center horizontally if needed */
  }
  .leaflet-container { background:#000; }

  /* port label styling */
  .port-label {
    color: #fff;
    font-weight: bold;
    font-size: 12px;
    text-shadow: 1px 1px 2px #000;
    pointer-events: none;
  }
</style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
const IMG_URL = 'https://i.postimg.cc/3xRtYPkG/map-Nero-AI-Image-Upscaler-Photo-Face.webp';
const IMG_WIDTH = 1005;
const IMG_HEIGHT = 500;

const map = L.map('map', {crs:L.CRS.Simple, minZoom:0, maxZoom:3});
const bounds = [[0,0],[IMG_HEIGHT,IMG_WIDTH]];
L.imageOverlay(IMG_URL, bounds).addTo(map);
map.fitBounds(bounds);

function invertY(y){ return IMG_HEIGHT - y; }

function createPortIcon(selected=false){
  return L.icon({
    iconUrl:'https://i.postimg.cc/wMs4zThh/anchor.png',
    iconSize: selected?[36,36]:[32,32],
    iconAnchor:[16,16]
  });
}

const ports=[
  { name:'Miami', coords:[invertY(174), 277] },
  { name:'London', coords:[invertY(102), 503] },
  { name:'Konigsberg', coords:[invertY(93), 558] }
];

// ROUTE LAYERS (PNG overlays for each route)
const routeLayers = {
  "Miami-London": L.imageOverlay('https://i.postimg.cc/nhxtPp26/pixil-layer-Layer-2.png', bounds).addTo(map).bringToFront(),
  "Miami-Konigsberg": L.imageOverlay('URL_TO_MIAMI_KONIGSBERG_ROUTE_PNG', bounds).addTo(map).bringToFront(),
  "London-Konigsberg": L.imageOverlay('https://i.postimg.cc/kGRSVxt1/pixil-layer-Layer-1.png', bounds).addTo(map).bringToFront()
};

// Initially hide all routes
for(const key in routeLayers){ routeLayers[key].setOpacity(0); }

const portMarkers={};
let selectedPorts=[];
let currentRouteLayer = null;

ports.forEach(port=>{
  const marker = L.marker(port.coords, {icon:createPortIcon(false), title:port.name}).addTo(map);
  portMarkers[port.name] = marker;

  L.marker(port.coords, {
    icon: L.divIcon({
      className: 'port-label',
      html: port.name,
      iconAnchor: [-10,-16]
    })
  }).addTo(map);

  marker.on('click', ()=>handlePortClick(port));
});

function updatePortIcons(){
  ports.forEach(port=>{
    const selected = selectedPorts.some(p=>p.name===port.name);
    portMarkers[port.name].setIcon(createPortIcon(selected));
  });
}

function handlePortClick(port){
  if(selectedPorts.some(p=>p.name===port.name)) return;
  selectedPorts.push(port);
  if(selectedPorts.length>2) selectedPorts.shift();
  updatePortIcons();
  updateRoute();
}

map.on('click', e=>{
  const clickedOnPort = ports.some(p=>{
    const dx = e.latlng.lat - p.coords[0];
    const dy = e.latlng.lng - p.coords[1];
    return Math.sqrt(dx*dx + dy*dy)<5;
  });
  if(!clickedOnPort){
    selectedPorts=[];
    updatePortIcons();
    if(currentRouteLayer){ currentRouteLayer.setOpacity(0); currentRouteLayer=null; }
    window.parent.postMessage({ startPort:null, endPort:null, portsAlongRoute:[] }, '*');
  }
});

function updateRoute(){
  if(selectedPorts.length<2) return;

  const start = selectedPorts[0].name;
  const end = selectedPorts[1].name;

  // Hide previous route
  if(currentRouteLayer){ currentRouteLayer.setOpacity(0); currentRouteLayer=null; }

  // Determine which route layer to show
  let key = `${start}-${end}`;
  if(!routeLayers[key]) key = `${end}-${start}`;
  if(routeLayers[key]){
    currentRouteLayer = routeLayers[key];
    currentRouteLayer.setOpacity(1); // show selected route
    currentRouteLayer.bringToFront();
  }

  let portsAlongRoute=[start];
  ports.forEach(p=>{
    if(p.name!==start && p.name!==end) portsAlongRoute.push(p.name);
  });
  portsAlongRoute.push(end);

  window.parent.postMessage({ startPort:start, endPort:end, portsAlongRoute }, '*');
}
</script>
</body>
</html>
