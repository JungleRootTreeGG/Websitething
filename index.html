<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Shipping Ordering System</title>
<style>
body { 
  margin:0; 
  font-family: system-ui, sans-serif; 
  background:#f5f5f5; 
}

iframe { 
  width: 100%; 
  height: 500px; 
  border: none; 
  display:block;
}

.order-section {
  padding: 20px;
  max-width: 800px;
  margin: 20px auto;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.order-section h2 { margin-top:0; }

.order-section form label { display:block; margin-bottom: 10px; }

.order-section form input, 
.order-section form select {
  width: 100%;
  padding: 6px 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
}

.order-section form small {
  display:block;
  font-size: 0.9em;
  color:#555;
  margin-bottom:10px;
}

.order-section form button {
  margin-top: 15px;
  padding: 10px 20px;
  border:none;
  border-radius: 6px;
  background:#00bcd4;
  color:#fff;
  font-size:16px;
  cursor:pointer;
}

.order-section form button:hover { background:#0098aa; }
</style>
</head>
<body>

<iframe src="map.html" id="mapFrame"></iframe>

<div class="order-section">
  <h2>Place Your Shipping Order</h2>
  <form id="orderForm">
    <label>From Port:
      <input type="text" id="fromPort" readonly required>
    </label>

    <label>To Port:
      <input type="text" id="toPort" readonly required>
    </label>

    <label>Discord Username:
      <input type="text" id="discord" required>
    </label>

    <label>In-game Username:
      <input type="text" id="ingame" required>
    </label>

    <label>Cargo Value ($):
      <input type="number" id="cargoValue" min="0" value="0" required>
    </label>

    <label>Container Type:
      <select id="containerType" required>
        <option value="">Select</option>
        <option value="Civilian">Civilian</option>
        <option value="Military">Military</option>
      </select>
    </label>

    <!-- Hidden field for nation if Military -->
    <div id="militaryNationContainer" style="display:none; margin-bottom:10px;">
      <label>Nation:
        <input type="text" id="militaryNation" placeholder="Enter your nation" required>
      </label>
    </div>

    <label>Container Number:
      <input type="text" id="containerNumber" placeholder="AAA 1234" required pattern="[A-Z]{3} \d{4}">
    </label>
    <small>Must be 3 capital letters followed by 4 digits (e.g., UAE 1234)</small>

    <label>Total Price ($):
      <input type="text" id="totalPrice" readonly>
    </label>

    <button type="submit" id="submitOrder">Submit Order</button>
  </form>
</div>

<script>
const perStopFee = 1000;
let routePortNames = [];

// Show/hide military nation field
const containerTypeSelect = document.getElementById('containerType');
const militaryNationContainer = document.getElementById('militaryNationContainer');

containerTypeSelect.addEventListener('change', () => {
  if(containerTypeSelect.value === "Military"){
    militaryNationContainer.style.display = "block";
    document.getElementById('militaryNation').required = true;
  } else {
    militaryNationContainer.style.display = "none";
    document.getElementById('militaryNation').required = false;
  }
});

// Listen for messages from the map iframe
window.addEventListener('message', (event) => {
  const data = event.data;
  if(data && data.startPort && data.endPort && Array.isArray(data.portsAlongRoute)){
    routePortNames = data.portsAlongRoute;
    document.getElementById('fromPort').value = data.startPort;
    document.getElementById('toPort').value = data.endPort;
    calculatePrice();
  }
});

function calculatePrice(){
  const cargoValue = parseFloat(document.getElementById('cargoValue').value) || 0;
  const stops = routePortNames.length || 0;
  const totalPrice = stops*perStopFee + cargoValue*0.1;
  document.getElementById('totalPrice').value = totalPrice.toFixed(2);
}

document.getElementById('cargoValue').addEventListener('input', calculatePrice);

// Handle form submission
const form = document.getElementById('orderForm');
const submitBtn = document.getElementById('submitOrder');

form.addEventListener('submit', async (e)=>{
  e.preventDefault();

  // Validate container number format
  const containerNumber = document.getElementById('containerNumber').value.trim();
  const regex = /^[A-Z]{3} \d{4}$/;
  if(!regex.test(containerNumber)){
    alert("Container number must be 3 capital letters followed by 4 digits (e.g., UAE 1234).");
    return;
  }

  // Validate route selection
  if(routePortNames.length === 0){
    alert("Please select a route on the map first!");
    return;
  }

  // Disable button to prevent spam
  submitBtn.disabled = true;
  submitBtn.textContent = "Submitting...";

  const orderData = {
    fromPort: document.getElementById('fromPort').value,
    toPort: document.getElementById('toPort').value,
    discord: document.getElementById('discord').value,
    ingame: document.getElementById('ingame').value,
    cargoValue: parseFloat(document.getElementById('cargoValue').value),
    containerType: containerTypeSelect.value,
    containerNumber: containerNumber,
    totalPrice: parseFloat(document.getElementById('totalPrice').value),
    portsAlongRoute: routePortNames,
    nation: containerTypeSelect.value === "Military" ? document.getElementById('militaryNation').value : null
  };

  // Prepare Discord webhook message
  const webhookURL = "YOUR_DISCORD_WEBHOOK_HERE";
  let content = `ðŸ“¦ **New Shipping Order**
**From:** ${orderData.fromPort}
**To:** ${orderData.toPort}
**Discord:** ${orderData.discord}
**In-game Username:** ${orderData.ingame}
**Cargo Value:** $${orderData.cargoValue.toFixed(2)}
**Container:** ${orderData.containerType} (#${orderData.containerNumber})`;

  if(orderData.nation) content += `\n**Nation:** ${orderData.nation}`;

  content += `\n**Stops:** ${orderData.portsAlongRoute.join(' â†’ ')}
**Total Price:** $${orderData.totalPrice.toFixed(2)}`;

  try {
    await fetch(webhookURL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ content })
    });

    // Redirect to confirmation page
    window.location.href = "confirmation.html";

  } catch(err){
    console.error(err);
    alert("Failed to send order.");
    submitBtn.disabled = false;
    submitBtn.textContent = "Submit Order";
  }
});
</script>

</body>
</html>
