<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Earth Shipping Routes - Chained Routes</title>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  crossorigin=""
/>
<style>
  html, body { margin:0; padding:0; height:100%; width:100%; }
  #map { height:100vh; width:100vw; }
  .leaflet-container { background:#000; }
</style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
/* =========================
   MAP CONFIGURATION
========================= */
const IMG_URL = 'https://i.postimg.cc/YSDwq0ms/map.webp';
const IMG_WIDTH = 1005;
const IMG_HEIGHT = 500;
const map = L.map('map',{crs:L.CRS.Simple, minZoom:-2, maxZoom:2});
const bounds=[[0,0],[IMG_HEIGHT,IMG_WIDTH]];
L.imageOverlay(IMG_URL,bounds).addTo(map);
map.fitBounds(bounds);

/* =========================
   HELPER
========================= */
function invertY(y){ return IMG_HEIGHT - y; }
function createPortIcon(selected=false){
  return L.icon({ 
    iconUrl:'https://i.postimg.cc/wMs4zThh/anchor.png',
    iconSize: selected?[48,48]:[42,42],
    iconAnchor:[24,24]
  });
}

/* =========================
   PORT DATA
========================= */
const ports=[
  { name:'Miami', coords:[invertY(171), 273] },
  { name:'London', coords:[invertY(102), 503] },
  { name:'Konigsberg', coords:[invertY(97), 560] }
];

/* =========================
   PRE-DEFINED ROUTES
========================= */
const routes=[
  {
    from:'Miami',
    to:'London',
    coords:[
      [invertY(171), 273],  // Miami
      [invertY(102), 503]   // London
    ]
  },
  {
    from:'London',
    to:'Konigsberg',
    coords:[
      [invertY(102), 503],  // London
      [invertY(93), 520],
      [invertY(84), 531],
      [invertY(93), 538],
      [invertY(97), 560]    // Konigsberg
    ]
  }
];

/* =========================
   PORT INTERACTION
========================= */
const portMarkers={};
let selectedPorts=[];
let routeLine=null;

// Add markers
ports.forEach(port=>{
  const marker=L.marker(port.coords,{icon:createPortIcon(false),title:port.name}).addTo(map);
  portMarkers[port.name]=marker;
  marker.on('click',()=>handlePortClick(port));
});

function updatePortIcons(){
  ports.forEach(port=>{
    const selected=selectedPorts.some(p=>p.name===port.name);
    portMarkers[port.name].setIcon(createPortIcon(selected));
  });
}

function handlePortClick(port){
  if(selectedPorts.some(p=>p.name===port.name)) return;
  selectedPorts.push(port);
  if(selectedPorts.length>2) selectedPorts.shift();
  updatePortIcons();
  updateRoute();
}

/* =========================
   ROUTE CHAINING
========================= */
function getRouteCoords(startName,endName){
  // 1) direct route exists
  let route = routes.find(r => 
    (r.from===startName && r.to===endName) || (r.from===endName && r.to===startName)
  );
  if(route) return route.coords;

  // 2) try to chain through intermediate ports
  for(let r1 of routes){
    const inter = r1.from===startName ? r1.to : r1.from===startName ? r1.to : r1.from;
    if(r1.from===startName || r1.to===startName){
      const intermediate = r1.from===startName ? r1.to : r1.from;
      const r2 = routes.find(r2=>
        (r2.from===intermediate && r2.to===endName) || (r2.from===endName && r2.to===intermediate)
      );
      if(r2){
        let coords = [...r1.coords];
        coords.pop(); // remove overlapping point
        coords.push(...r2.coords);
        return coords;
      }
    }
  }

  return null; // no route found
}

function updateRoute(){
  if(routeLine){ map.removeLayer(routeLine); routeLine=null; }
  if(selectedPorts.lengt
